<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ˜Ÿéš› 211 åå™¬è€… | æˆ‘çš„é¤ç›¤äº’å‹•éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            touch-action: none;
        }
        canvas {
            display: block;
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .neon-text {
            color: #fff;
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #0ea5e9, 0 0 40px #0ea5e9;
        }
        .slide-hidden { display: none; opacity: 0; }
        .slide-active {
            display: flex; opacity: 1;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* æ‹¼åœ–æ¨¡å¼å°ˆå±¬æ¨£å¼ */
        .puzzle-item { transition: all 0.2s; cursor: pointer; }
        .puzzle-item.selected {
            transform: scale(1.1);
            box-shadow: 0 0 15px 5px rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
        }
        .puzzle-zone { transition: all 0.2s; cursor: pointer; }
        .puzzle-zone:hover { background-color: rgba(255, 255, 255, 0.1); }
        .puzzle-zone.matched {
            background-color: rgba(16, 185, 129, 0.2);
            pointer-events: none;
            border-color: #10b981;
        }
        .shake { animation: shake 0.4s; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <!-- ä»‹ç´¹ç•«é¢è¦†è“‹å±¤ -->
    <div id="intro-overlay" class="absolute inset-0 bg-slate-900/95 flex items-center justify-center z-30 backdrop-blur-md transition-opacity duration-500">
        <div class="max-w-2xl w-full p-6 md:p-10 glass-panel rounded-3xl text-center text-white border-2 border-slate-700 shadow-2xl mx-4 relative overflow-hidden">
            <!-- Slide 1: æ³¢æ³¢çš„æ•…äº‹ -->
            <div id="slide-1" class="slide-active flex-col items-center">
                <h2 class="text-3xl md:text-5xl font-black mb-6 text-amber-400">æ¢éšªå®¶ã€Œæ³¢æ³¢ã€çš„å±æ©Ÿï¼</h2>
                <div class="bg-slate-800 p-6 rounded-2xl mb-8 text-left space-y-4 text-lg border border-slate-700 w-full relative">
                    <div class="absolute -top-10 -right-4 text-8xl drop-shadow-2xl animate-bounce">ğŸ‘¾</div>
                    <p>æ³¢æ³¢æ˜¯ä¸€éš»ç†±æ„›æ¢ç´¢å®‡å®™çš„å¤–æ˜Ÿäººï¼Œä½†æœ€è¿‘ä»–åœ¨èˆªè¡Œæ™‚ï¼Œå¸¸å¸¸è¦ºå¾—é ­æšˆç›®çœ©ã€å…¨èº«æ²’åŠ›ã€èº«æé‚„èµ°æ¨£...</p>
                    <p>èˆ¹é•·å‘Šè¨´ä»–ï¼š<span class="text-rose-400 font-bold">ã€Œæ³¢æ³¢ï¼ä½ äº‚åƒå¤ªå¤šå®‡å®™åƒåœ¾é£Ÿç‰©ï¼Œèƒ½é‡å¿«è€—ç›¡äº†ï¼ã€</span></p>
                    <div class="bg-slate-900 p-4 rounded-xl border border-slate-600 mt-4">
                        <p class="text-emerald-400 font-bold text-xl mb-2">ğŸ’¡ æ‹¯æ•‘æ³¢æ³¢çš„æ–¹æ³•ï¼š</p>
                        <p class="text-slate-300">æ”¶é›†èƒ½é‡é”æˆ <span class="text-yellow-400 font-bold text-2xl">20</span> é—œï¼Œå®Œæˆçµ‚æ¥µã€Œæˆ‘çš„é¤ç›¤ã€æ‹¼åœ–ï¼Œå¹«ä»–æ¢å¾©æ»¿æ»¿æ´»åŠ›ï¼</p>
                    </div>
                </div>
                <button onclick="nextSlide(2)" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-xl text-xl transition shadow-lg w-full md:w-auto transform hover:scale-105">çœ‹èƒ½é‡ç§˜æ–¹ â¡ï¸</button>
            </div>

            <!-- Slide 2: 211é¤ç›¤ -->
            <div id="slide-2" class="slide-hidden flex-col items-center">
                <h2 class="text-3xl md:text-5xl font-black mb-6 text-emerald-400">ä»€éº¼æ˜¯ 211 é¤ç›¤ï¼Ÿ</h2>
                <div class="flex flex-col md:flex-row items-center justify-center gap-6 mb-8">
                    <div class="w-48 h-48 rounded-full border-8 border-slate-700 relative overflow-hidden flex flex-wrap bg-slate-800 shadow-inner shrink-0">
                        <div class="w-full h-1/2 bg-emerald-500/30 border-b-4 border-slate-700 flex items-center justify-center text-2xl font-black">ğŸ¥— 50%</div>
                        <div class="w-1/2 h-1/2 bg-rose-500/30 border-r-4 border-slate-700 flex items-center justify-center text-xl font-black">ğŸ¥© 25%</div>
                        <div class="w-1/2 h-1/2 bg-amber-500/30 flex items-center justify-center text-xl font-black">ğŸš 25%</div>
                    </div>
                    <div class="text-left space-y-4 text-lg">
                        <p><span class="text-emerald-400 font-bold text-xl drop-shadow-sm">ğŸŸ¢ 2ä»½ è”¬èœï¼š</span><br><span class="text-slate-300">è±å¯Œè†³é£Ÿçº–ç¶­ï¼Œå¹«åŠ©æ³¢æ³¢æ¶ˆåŒ–</span></p>
                        <p><span class="text-rose-400 font-bold text-xl drop-shadow-sm">ğŸ”´ 1ä»½ è›‹ç™½è³ªï¼š</span><br><span class="text-slate-300">è±†é­šè›‹è‚‰é¡ï¼Œç¶­æŒæ³¢æ³¢çš„è‚Œè‚‰é‡</span></p>
                        <p><span class="text-amber-400 font-bold text-xl drop-shadow-sm">ğŸŸ¡ 1ä»½ å…¨ç©€é›œç³§ï¼š</span><br><span class="text-slate-300">ç³™ç±³æˆ–åœ°ç“œï¼Œæä¾›é£›èˆ¹å¤§è…¦èƒ½é‡</span></p>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 justify-center w-full">
                    <button onclick="nextSlide(1)" class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl text-lg transition shadow-lg shrink-0">â¬…ï¸ ä¸Šä¸€é </button>
                    <button onclick="nextSlide(3)" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-black rounded-xl text-xl transition shadow-lg flex-1 transform hover:scale-105">é‚„æœ‰éš±è—èƒ½é‡ï¼Ÿ â¡ï¸</button>
                </div>
            </div>

            <!-- Slide 3: æˆ‘çš„é¤ç›¤ -->
            <div id="slide-3" class="slide-hidden flex-col items-center">
                <h2 class="text-3xl md:text-5xl font-black mb-6 text-blue-400 leading-tight">åŠ ä¸Šã€Œæˆ‘çš„é¤ç›¤ã€<br class="md:hidden">é˜²è­·ç½©ï¼</h2>
                <div class="bg-slate-800 p-6 rounded-2xl mb-8 text-left space-y-6 text-lg border border-slate-700 w-full">
                    <div class="flex items-center gap-6">
                        <div class="text-6xl drop-shadow-xl shrink-0">ğŸ¥›</div>
                        <div>
                            <p class="font-black text-blue-300 text-2xl mb-1">æ¯å¤©æ—©æ™šä¸€æ¯å¥¶</p>
                            <p class="text-slate-400">è£œå……éˆ£è³ªï¼Œè®“æ³¢æ³¢çš„éª¨éª¼æ›´å¼·å£¯ï¼</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-6xl drop-shadow-xl shrink-0">ğŸ¥œ</div>
                        <div>
                            <p class="font-black text-amber-300 text-2xl mb-1">æ¯é¤å …æœç¨®å­ä¸€èŒ¶åŒ™</p>
                            <p class="text-slate-400">æ”å–å¥½æ²¹è„‚ï¼Œä¿è­·å¿ƒè¡€ç®¡èˆ‡å¤§è…¦ï¼</p>
                        </div>
                    </div>
                </div>
                <div class="bg-emerald-900/50 p-4 rounded-xl border border-emerald-500/30 mb-8 w-full">
                    <p class="text-emerald-400 font-bold text-xl">ğŸ’¡ éŠæˆ²ä¸­åƒåˆ°ä¹³å“æˆ–å …æœï¼Œæœƒç²å¾—ç„¡æ•µé˜²è­·ç½©å–”ï¼</p>
                </div>
                <div class="flex flex-col md:flex-row gap-4 justify-center w-full">
                    <button onclick="nextSlide(2)" class="px-6 py-4 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl text-lg transition shadow-lg shrink-0">â¬…ï¸ ä¸Šä¸€é </button>
                    <button onclick="closeIntro()" class="px-8 py-4 bg-emerald-500 hover:bg-emerald-400 text-white font-black rounded-xl text-xl transition shadow-lg flex-1 transform hover:scale-105">å¹«åŠ©æ³¢æ³¢ç™¼å°„ï¼ ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UI å±¤ -->
    <div id="ui-layer" class="absolute inset-0 pointer-events-none flex flex-col justify-between p-4 z-10">
        <!-- é ‚éƒ¨è³‡è¨Šåˆ— -->
        <div class="flex justify-between items-start">
            <div class="glass-panel p-3 rounded-xl text-white shadow-lg pointer-events-auto">
                <div class="text-sm text-slate-400">åˆ†æ•¸ SCORE</div>
                <div id="score-display" class="text-3xl font-black text-yellow-400">0</div>
            </div>
            
            <div class="glass-panel p-3 rounded-xl text-white shadow-lg text-center pointer-events-auto">
                <div class="text-sm text-slate-400">å‰©é¤˜æ™‚é–“ TIME</div>
                <div id="time-display" class="text-3xl font-black text-rose-400">60</div>
            </div>

            <div class="glass-panel p-3 rounded-xl text-white shadow-lg text-right pointer-events-auto">
                <div class="text-sm text-slate-400">ç­‰ç´š LEVEL</div>
                <div id="level-display" class="text-3xl font-black text-emerald-400">1<span class="text-sm text-slate-400 ml-1">/ 20</span></div>
            </div>
        </div>

        <!-- å·¦ä¸‹è§’ï¼šç›®å‰é¤ç›¤ HUD -->
        <div id="plate-hud" class="absolute bottom-4 left-4 glass-panel p-3 rounded-xl shadow-lg pointer-events-none transition-opacity duration-300 scale-90 md:scale-100 origin-bottom-left">
            <div class="text-sm text-slate-400 mb-2 font-bold tracking-wider">ğŸ½ï¸ ç›®å‰é¤ç›¤å…§å®¹</div>
            <div class="flex gap-2 md:gap-3">
                <div class="bg-slate-800/80 p-2 rounded-lg min-w-[70px] border border-emerald-500/30">
                    <div class="text-emerald-400 text-xs font-bold mb-1">è”¬èœ (4)</div>
                    <div id="hud-v" class="text-2xl min-h-[32px] tracking-widest drop-shadow-md"></div>
                </div>
                <div class="bg-slate-800/80 p-2 rounded-lg min-w-[70px] border border-rose-500/30">
                    <div class="text-rose-400 text-xs font-bold mb-1">è›‹ç™½è³ª (2)</div>
                    <div id="hud-p" class="text-2xl min-h-[32px] tracking-widest drop-shadow-md"></div>
                </div>
                <div class="bg-slate-800/80 p-2 rounded-lg min-w-[70px] border border-amber-500/30">
                    <div class="text-amber-400 text-xs font-bold mb-1">å…¨ç©€ (2)</div>
                    <div id="hud-c" class="text-2xl min-h-[32px] tracking-widest drop-shadow-md"></div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨æç¤ºåˆ— -->
        <div class="text-center mb-4 md:mb-8 absolute bottom-0 left-0 right-0 pointer-events-none">
            <div id="message-display" class="inline-block glass-panel px-6 py-2 rounded-full text-white font-bold text-lg opacity-0 transition-opacity duration-300 shadow-xl"></div>
        </div>
    </div>

    <!-- æ‹¼åœ–éé—œç•«é¢è¦†è“‹å±¤ (çµ‚æ¥µæŒ‘æˆ°) -->
    <div id="puzzle-overlay" class="hidden absolute inset-0 bg-slate-900/95 flex items-center justify-center z-40 backdrop-blur-md">
        <div class="max-w-4xl w-full p-4 md:p-8 glass-panel rounded-3xl text-center text-white border-2 border-slate-700 shadow-2xl mx-4 flex flex-col items-center">
            <h2 class="text-3xl md:text-4xl font-black mb-2 text-emerald-400 neon-text">çµ‚æ¥µæŒ‘æˆ°ï¼šæˆ‘çš„é¤ç›¤å¤§æ‹¼åœ–</h2>
            
            <!-- æç¤ºè¨Šæ¯å€ -->
            <div id="puzzle-message" class="h-16 mb-4 flex items-center justify-center text-center font-bold text-lg md:text-xl text-blue-300 bg-slate-800/50 w-full rounded-xl whitespace-pre-line">
                ğŸ‘‰ é»é¸ä¸‹æ–¹çš„é£Ÿç‰©ï¼Œå†é»æ“Šå°æ‡‰çš„é¤ç›¤ä½ç½®ï¼
            </div>

            <div class="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-16 w-full mb-8">
                <!-- é¤ç›¤å€ -->
                <div class="relative w-64 h-64 md:w-80 md:h-80 flex-shrink-0">
                    <!-- å …æœ (å·¦å¤–å´) -->
                    <div class="absolute -left-12 bottom-0 w-16 h-16 rounded-full border-4 border-slate-500 bg-slate-800 puzzle-zone flex items-center justify-center text-4xl shadow-lg z-10" data-target="nut" onclick="placePuzzleFood(this, 'nut')">
                        <span class="text-[10px] md:text-xs text-slate-400 absolute -top-6 whitespace-nowrap">å …æœä¸€èŒ¶åŒ™</span>
                    </div>
                    <!-- ä¹³å“ (å³å¤–å´) -->
                    <div class="absolute -right-12 top-0 w-20 h-20 rounded-full border-4 border-slate-500 bg-slate-800 puzzle-zone flex items-center justify-center text-4xl shadow-lg z-10" data-target="dairy" onclick="placePuzzleFood(this, 'dairy')">
                        <span class="text-[10px] md:text-xs text-slate-400 absolute -top-6 whitespace-nowrap">æ—©æ™šä¸€æ¯å¥¶</span>
                    </div>

                    <!-- ä¸»é¤ç›¤æœ¬é«” -->
                    <div class="w-full h-full rounded-full border-8 border-slate-300 bg-slate-800 overflow-hidden flex flex-wrap shadow-2xl relative">
                        <!-- å·¦ä¸Š: æ°´æœ -->
                        <div class="w-1/2 h-[45%] border-r-2 border-b-2 border-slate-600 puzzle-zone flex flex-col items-center justify-center p-2 text-4xl md:text-6xl" data-target="fruit" onclick="placePuzzleFood(this, 'fruit')">
                            <span class="text-xs md:text-sm text-slate-400 font-bold mb-1">æ°´æœå€</span>
                        </div>
                        <!-- å³ä¸Š: è›‹ç™½è³ª -->
                        <div class="w-1/2 h-[45%] border-b-2 border-slate-600 puzzle-zone flex flex-col items-center justify-center p-2 text-4xl md:text-6xl" data-target="pro" onclick="placePuzzleFood(this, 'pro')">
                            <span class="text-xs md:text-sm text-slate-400 font-bold mb-1">è±†é­šè›‹è‚‰</span>
                        </div>
                        <!-- å·¦ä¸‹: è”¬èœ (é¢ç©æœ€å¤§) -->
                        <div class="w-1/2 h-[55%] border-r-2 border-slate-600 puzzle-zone flex flex-col items-center justify-center p-2 text-4xl md:text-6xl" data-target="veg" onclick="placePuzzleFood(this, 'veg')">
                            <span class="text-xs md:text-sm text-slate-400 font-bold mb-1">è”¬èœå€</span>
                        </div>
                        <!-- å³ä¸‹: å…¨ç©€é›œç³§ -->
                        <div class="w-1/2 h-[55%] puzzle-zone flex flex-col items-center justify-center p-2 text-4xl md:text-6xl" data-target="carb" onclick="placePuzzleFood(this, 'carb')">
                            <span class="text-xs md:text-sm text-slate-400 font-bold mb-1">å…¨ç©€é›œç³§</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¾…é¸é£Ÿç‰©å€ -->
            <div class="grid grid-cols-3 md:grid-cols-6 gap-3 md:gap-6 w-full max-w-3xl">
                <div class="puzzle-item bg-slate-800 border-2 border-slate-600 rounded-xl p-4 flex flex-col items-center shadow-lg" data-type="pro" onclick="selectPuzzleFood(this, 'pro')">
                    <span class="text-4xl mb-2">ğŸ—</span><span class="text-sm font-bold">çƒ¤é›è…¿</span>
                </div>
                <div class="puzzle-item bg-slate-800 border-2 border-slate-600 rounded-xl p-4 flex flex-col items-center shadow-lg" data-type="carb" onclick="selectPuzzleFood(this, 'carb')">
                    <span class="text-4xl mb-2">ğŸš</span><span class="text-sm font-bold">ç³™ç±³é£¯</span>
                </div>
                <div class="puzzle-item bg-slate-800 border-2 border-slate-600 rounded-xl p-4 flex flex-col items-center shadow-lg" data-type="veg" onclick="selectPuzzleFood(this, 'veg')">
                    <span class="text-4xl mb-2">ğŸ¥¦</span><span class="text-sm font-bold">ç‚’é’èœ</span>
                </div>
                <div class="puzzle-item bg-slate-800 border-2 border-slate-600 rounded-xl p-4 flex flex-col items-center shadow-lg" data-type="dairy" onclick="selectPuzzleFood(this, 'dairy')">
                    <span class="text-4xl mb-2">ğŸ¥›</span><span class="text-sm font-bold">é®®å¥¶</span>
                </div>
                <div class="puzzle-item bg-slate-800 border-2 border-slate-600 rounded-xl p-4 flex flex-col items-center shadow-lg" data-type="fruit" onclick="selectPuzzleFood(this, 'fruit')">
                    <span class="text-4xl mb-2">ğŸ</span><span class="text-sm font-bold">è˜‹æœ</span>
                </div>
                <div class="puzzle-item bg-slate-800 border-2 border-slate-600 rounded-xl p-4 flex flex-col items-center shadow-lg" data-type="nut" onclick="selectPuzzleFood(this, 'nut')">
                    <span class="text-4xl mb-2">ğŸ¥œ</span><span class="text-sm font-bold">æ ¸æ¡ƒ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤±æ•—æˆ–æœ€çµ‚å‹åˆ©è¦†è“‹å±¤ -->
    <div id="overlay" class="absolute inset-0 bg-slate-900/90 flex items-center justify-center z-20 backdrop-blur-sm pointer-events-auto hidden">
        <div id="overlay-content" class="max-w-md w-full p-8 glass-panel rounded-3xl text-center text-white border-2 border-slate-700 shadow-2xl mx-4">
            <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

<script>
/**
 * éŠæˆ²å¼•æ“èˆ‡é‚è¼¯
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const overlayContent = document.getElementById('overlay-content');
const scoreDisplay = document.getElementById('score-display');
const timeDisplay = document.getElementById('time-display');
const levelDisplay = document.getElementById('level-display');
const messageDisplay = document.getElementById('message-display');

const hudV = document.getElementById('hud-v');
const hudP = document.getElementById('hud-p');
const hudC = document.getElementById('hud-c');

// èª¿æ•´ç•«å¸ƒå¤§å°
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// --- éŠæˆ²è³‡æ–™åº« (Emoji é£Ÿç‰©) ---
const FOOD_TYPES = {
    VEG: { id: 'v', color: '#34d399', name: 'è”¬èœ', emojis: ['ğŸ¥¦', 'ğŸ¥•', 'ğŸ…', 'ğŸ¥¬', 'ğŸ†', 'ğŸ„', 'ğŸ§…', 'ğŸ¥’'], max: 4 },
    PRO: { id: 'p', color: '#fb7185', name: 'è›‹ç™½è³ª', emojis: ['ğŸ—', 'ğŸŸ', 'ğŸ¥š', 'ğŸ¥©', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦€'], max: 2 },
    CARB: { id: 'c', color: '#fbbf24', name: 'å…¨ç©€é›œç³§', emojis: ['ğŸš', 'ğŸ ', 'ğŸŒ½', 'ğŸ', 'ğŸ¥”', 'ğŸœ', 'ğŸ¥', 'ğŸ¥Ÿ'], max: 2 },
    BONUS: { id: 'b', color: '#60a5fa', name: 'å¥åº·åŠ æˆ', emojis: ['ğŸ¥›', 'ğŸ¥œ', 'ğŸ§€', 'ğŸŒ°'] },
    JUNK: { id: 'j', color: '#94a3b8', name: 'åœ°é›·', emojis: ['ğŸ”', 'ğŸŸ', 'ğŸ¥¤', 'ğŸ°', 'ğŸ©', 'ğŸ«', 'ğŸ•', 'ğŸ¦'] }
};

// --- éŠæˆ²ç‹€æ…‹ ---
let gameState = {
    isRunning: false,
    score: 0,
    time: 60,
    level: 1,
    lastTime: 0,
    timerInterval: null
};

// --- å¯¦é«”é¡åˆ¥ ---

class Player {
    constructor() {
        this.radius = 40;
        this.x = canvas.width / 2;
        this.y = canvas.height / 2;
        this.targetX = this.x;
        this.targetY = this.y;
        this.speed = 0.15; 
        this.inventory = { v: 0, p: 0, c: 0 };
        this.collectedEmojis = { v: [], p: [], c: [] }; 
        this.invincibleTimer = 0;
        this.rotation = 0;
    }

    update(dt) {
        this.x += (this.targetX - this.x) * this.speed;
        this.y += (this.targetY - this.y) * this.speed;
        this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
        this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
        if (this.invincibleTimer > 0) this.invincibleTimer -= dt;
        this.rotation += 0.02;
    }

    draw(ctx) {
        if (this.invincibleTimer > 0) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius + 15 + Math.sin(Date.now()*0.01)*5, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(96, 165, 250, 0.3)';
            ctx.fill();
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        const ringRadius = this.radius + 8;
        ctx.lineWidth = 12;

        ctx.beginPath();
        ctx.arc(this.x, this.y, ringRadius, 0, Math.PI * 2);
        ctx.strokeStyle = '#334155';
        ctx.stroke();

        let currentAngle = -Math.PI / 2; 

        if (this.inventory.v > 0) {
            const vAngle = (this.inventory.v / 8) * (Math.PI * 2);
            ctx.beginPath(); ctx.arc(this.x, this.y, ringRadius, currentAngle, currentAngle + vAngle);
            ctx.strokeStyle = FOOD_TYPES.VEG.color; ctx.stroke(); currentAngle += vAngle;
        }

        if (this.inventory.p > 0) {
            const pAngle = (this.inventory.p / 8) * (Math.PI * 2);
            ctx.beginPath(); ctx.arc(this.x, this.y, ringRadius, currentAngle, currentAngle + pAngle);
            ctx.strokeStyle = FOOD_TYPES.PRO.color; ctx.stroke(); currentAngle += pAngle;
        }

        if (this.inventory.c > 0) {
            const cAngle = (this.inventory.c / 8) * (Math.PI * 2);
            ctx.beginPath(); ctx.arc(this.x, this.y, ringRadius, currentAngle, currentAngle + cAngle);
            ctx.strokeStyle = FOOD_TYPES.CARB.color; ctx.stroke();
        }

        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.beginPath(); ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#1e293b'; ctx.fill();
        ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 3; ctx.stroke();

        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(-12, -10, 8, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(12, -10, 8, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = '#000';
        let eyeDx = Math.max(-4, Math.min(4, (this.targetX - this.x) * 0.02));
        let eyeDy = Math.max(-4, Math.min(4, (this.targetY - this.y) * 0.02));
        ctx.beginPath(); ctx.arc(-12 + eyeDx, -10 + eyeDy, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(12 + eyeDx, -10 + eyeDy, 4, 0, Math.PI*2); ctx.fill();

        ctx.beginPath(); ctx.arc(0, 10, 10, 0, Math.PI, false);
        ctx.fillStyle = '#ef4444'; ctx.fill();
        ctx.restore();
    }
}

class Food {
    constructor(typeObj) {
        this.typeObj = typeObj;
        this.emoji = typeObj.emojis[Math.floor(Math.random() * typeObj.emojis.length)];
        this.radius = 28; 
        
        if (Math.random() > 0.5) {
            this.x = Math.random() > 0.5 ? -this.radius : canvas.width + this.radius;
            this.y = Math.random() * canvas.height;
        } else {
            this.x = Math.random() * canvas.width;
            this.y = Math.random() > 0.5 ? -this.radius : canvas.height + this.radius;
        }

        const targetX = canvas.width/2 + (Math.random() - 0.5) * 300;
        const targetY = canvas.height/2 + (Math.random() - 0.5) * 300;
        const angle = Math.atan2(targetY - this.y, targetX - this.x);
        
        // ã€å„ªåŒ–ã€‘é™åˆ¶æœ€å¤§é£›è¡Œé€Ÿåº¦ï¼Œè§£æ±ºå¾ŒæœŸç©ä¸ä¸‹å»çš„å•é¡Œ
        const baseSpeed = 1.5 + Math.random() * 2.0;
        const levelBonus = Math.min((gameState.level - 1) * 0.15, 2.5); // æœ€é«˜åªå¢åŠ  2.5 é€Ÿåº¦
        const speed = baseSpeed + levelBonus;
        
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.rotation = Math.random() * Math.PI * 2;
        this.rotSpeed = (Math.random() - 0.5) * 0.05;
        this.markedForDeletion = false;
        this.lifeTime = 0;
    }

    update(dt) {
        this.x += this.vx;
        this.y += this.vy;
        this.rotation += this.rotSpeed;
        this.lifeTime += dt;

        if (this.lifeTime > 2000 && (this.x < -150 || this.x > canvas.width + 150 || this.y < -150 || this.y > canvas.height + 150)) {
            this.markedForDeletion = true;
        }
    }

    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotation);
        ctx.shadowBlur = 15;
        ctx.shadowColor = this.typeObj.color;
        ctx.font = '40px "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", Arial, sans-serif';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(this.emoji, 0, 0);
        ctx.restore();
    }
}

class Particle {
    constructor(x, y, color, text) {
        this.x = x; this.y = y;
        this.vx = (Math.random() - 0.5) * 4; this.vy = (Math.random() - 0.5) * 4 - 2;
        this.life = 1.0; this.color = color; this.text = text;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; }
    draw(ctx) {
        ctx.save(); ctx.globalAlpha = Math.max(0, this.life);
        if (this.text) {
            ctx.font = 'bold 24px "Apple Color Emoji", "Segoe UI Emoji", "Noto Sans TC", sans-serif';
            ctx.fillStyle = this.color; ctx.textAlign = 'center';
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = 3;
            ctx.strokeText(this.text, this.x, this.y); ctx.fillText(this.text, this.x, this.y);
        } else {
            ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, Math.PI*2);
            ctx.fillStyle = this.color; ctx.fill();
        }
        ctx.restore();
    }
}

// --- éŠæˆ²è®Šæ•¸ ---
let player;
let foods = [];
let particles = [];
let foodSpawnTimer = 0;

function getRandomFoodType() {
    const rand = Math.random();
    if (rand < 0.35) return FOOD_TYPES.VEG;
    else if (rand < 0.55) return FOOD_TYPES.PRO;
    else if (rand < 0.75) return FOOD_TYPES.CARB;
    else if (rand < 0.85) return FOOD_TYPES.BONUS;
    else return FOOD_TYPES.JUNK;
}

// --- ä»‹ç´¹ç•«é¢é‚è¼¯ ---
function nextSlide(n) {
    for (let i = 1; i <= 3; i++) {
        let slide = document.getElementById('slide-' + i);
        if (slide) { slide.classList.remove('slide-active'); slide.classList.add('slide-hidden'); }
    }
    let targetSlide = document.getElementById('slide-' + n);
    if (targetSlide) { targetSlide.classList.remove('slide-hidden'); targetSlide.classList.add('slide-active'); }
}

function closeIntro() {
    const introOverlay = document.getElementById('intro-overlay');
    introOverlay.style.opacity = '0';
    setTimeout(() => {
        introOverlay.style.display = 'none';
        startGame(); // é—œé–‰å°è¦½å¾Œè‡ªå‹•é–‹å§‹éŠæˆ²
    }, 500);
}

// --- UI æ›´æ–°é‚è¼¯ ---
function updateHUD() {
    hudV.textContent = player.collectedEmojis.v.join('');
    hudP.textContent = player.collectedEmojis.p.join('');
    hudC.textContent = player.collectedEmojis.c.join('');
}

function updateUI() {
    scoreDisplay.textContent = gameState.score;
    levelDisplay.innerHTML = `${gameState.level}<span class="text-sm text-slate-400 ml-1">/ 20</span>`;
    timeDisplay.textContent = Math.ceil(gameState.time);
}

function showMessage(text, colorClass = 'text-white') {
    messageDisplay.textContent = text;
    messageDisplay.className = `inline-block glass-panel px-6 py-2 rounded-full font-bold text-lg transition-opacity duration-300 ${colorClass} opacity-100 shadow-xl`;
    if (window.msgTimeout) clearTimeout(window.msgTimeout);
    window.msgTimeout = setTimeout(() => {
        messageDisplay.classList.remove('opacity-100'); messageDisplay.classList.add('opacity-0');
    }, 1500);
}

function spawnParticles(x, y, color, text = null, count = 5) {
    if (text) particles.push(new Particle(x, y, color, text));
    for (let i = 0; i < count; i++) particles.push(new Particle(x, y, color, null));
}

function updateTarget(e) {
    if (!gameState.isRunning) return;
    e.preventDefault();
    if (e.touches && e.touches.length > 0) {
        player.targetX = e.touches[0].clientX; player.targetY = e.touches[0].clientY;
    } else {
        player.targetX = e.clientX; player.targetY = e.clientY;
    }
}
window.addEventListener('mousemove', updateTarget);
window.addEventListener('touchmove', updateTarget, {passive: false});
window.addEventListener('touchstart', updateTarget, {passive: false});

// --- æ ¸å¿ƒé‚è¼¯ ---

function check211Complete() {
    if (player.inventory.v === 4 && player.inventory.p === 2 && player.inventory.c === 2) {
        gameState.score += 500;
        gameState.level++;
        gameState.time += 15;
        
        player.inventory = { v: 0, p: 0, c: 0 };
        player.collectedEmojis = { v: [], p: [], c: [] };
        updateUI(); updateHUD();
        
        // ã€å„ªåŒ–ã€‘åˆ°é”ç¬¬ 21 é—œ (å·²é 20 é—œ) è§¸ç™¼éé—œæ‹¼åœ–
        if (gameState.level > 20) {
            gameState.isRunning = false;
            clearInterval(gameState.timerInterval);
            
            showMessage("ğŸ‰ æ­å–œé€šé 20 é—œï¼å³å°‡é€²å…¥çµ‚æ¥µæŒ‘æˆ°ï¼", "text-yellow-400");
            spawnParticles(player.x, player.y, '#fbbf24', 'ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼', 30);
            
            setTimeout(() => {
                document.getElementById('puzzle-overlay').classList.remove('hidden');
            }, 2500);
            return true;
        }

        showMessage("ğŸŒŸ å®Œç¾ 211 é¤ç›¤ï¼ç­‰ç´šæå‡ï¼", "text-yellow-400");
        spawnParticles(player.x, player.y, '#fbbf24', 'ğŸŒŸ LEVEL UP!', 20);
        return true;
    }
    return false;
}

function handleEating(food) {
    const type = food.typeObj;
    if (type.id === 'j') {
        if (player.invincibleTimer > 0) {
            spawnParticles(food.x, food.y, '#fff', 'ğŸ›¡ï¸ ç„¡æ•µå½ˆé–‹ï¼'); return false;
        } else {
            gameState.time -= 5;
            gameState.score = Math.max(0, gameState.score - 50);
            showMessage(`âš ï¸ åƒåˆ° ${food.emoji}ï¼æ‰£ 5 ç§’ï¼`, "text-red-500");
            spawnParticles(food.x, food.y, type.color, `${food.emoji} ğŸ’”`, 10);
            updateUI();
            ctx.translate((Math.random()-0.5)*20, (Math.random()-0.5)*20);
            setTimeout(() => ctx.setTransform(1, 0, 0, 1, 0, 0), 50);
            return true;
        }
    }

    if (type.id === 'b') {
        player.invincibleTimer = 5000;
        gameState.score += 100;
        showMessage(`ğŸ›¡ï¸ åƒåˆ° ${food.emoji} ç²å¾—å¥åº·é˜²è­·ç½©ï¼`, "text-blue-400");
        spawnParticles(food.x, food.y, type.color, `${food.emoji} ç„¡æ•µï¼`, 15);
        updateUI(); return true;
    }

    if (player.inventory[type.id] < type.max) {
        player.inventory[type.id]++;
        player.collectedEmojis[type.id].push(food.emoji);
        gameState.score += 10;
        spawnParticles(food.x, food.y, type.color, `${food.emoji} +1 ${type.name}`);
        updateUI(); updateHUD(); check211Complete(); return true;
    } else {
        showMessage(`ğŸ›‘ ${type.name}å·²ç¶“å¤ å›‰ï¼`, "text-slate-300");
        food.vx *= -1.5; food.vy *= -1.5; return false;
    }
}

// --- éŠæˆ²è¿´åœˆ ---
function gameLoop(timestamp) {
    if (!gameState.isRunning) return;
    const dt = timestamp - gameState.lastTime;
    gameState.lastTime = timestamp;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
    ctx.lineWidth = 1;
    const gridSize = 100;
    const offsetX = (Date.now() * 0.02) % gridSize;
    const offsetY = (Date.now() * 0.02) % gridSize;
    ctx.beginPath();
    for(let x = offsetX; x < canvas.width; x += gridSize) { ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); }
    for(let y = offsetY; y < canvas.height; y += gridSize) { ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); }
    ctx.stroke();

    player.update(dt); player.draw(ctx);

    foodSpawnTimer -= dt;
    if (foodSpawnTimer <= 0) {
        // ã€å„ªåŒ–ã€‘é™åˆ¶æœ€å¿«ç”Ÿæˆé »ç‡ (å¾200msæ”¾å¯¬åˆ°400ms)ï¼Œç¢ºä¿ä¸æœƒæ»¿ç•«é¢éƒ½æ˜¯é£Ÿç‰©
        const spawnRate = Math.max(400, 800 - (gameState.level * 15)); 
        foodSpawnTimer = spawnRate;
        foods.push(new Food(getRandomFoodType()));
    }

    for (let i = foods.length - 1; i >= 0; i--) {
        let f = foods[i];
        f.update(dt); f.draw(ctx);
        const distance = Math.sqrt(Math.pow(player.x - f.x, 2) + Math.pow(player.y - f.y, 2));
        if (distance < player.radius + f.radius && handleEating(f)) f.markedForDeletion = true;
        if (f.markedForDeletion) foods.splice(i, 1);
    }

    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.update(); p.draw(ctx);
        if (p.life <= 0) particles.splice(i, 1);
    }
    requestAnimationFrame(gameLoop);
}

function startTimer() {
    if (gameState.timerInterval) clearInterval(gameState.timerInterval);
    gameState.timerInterval = setInterval(() => {
        if (!gameState.isRunning) return;
        gameState.time -= 1; updateUI();
        if (gameState.time <= 0) gameOver();
    }, 1000);
}

function startGame() {
    overlay.classList.add('hidden');
    player = new Player(); foods = []; particles = [];
    gameState.score = 0; gameState.time = 60; gameState.level = 1;
    gameState.isRunning = true; gameState.lastTime = performance.now();
    
    updateUI(); updateHUD(); startTimer(); showMessage("å¹«åŠ©æ³¢æ³¢ï¼å¿«åƒè”¬èœï¼");
    
    for(let i = 0; i < 15; i++) {
        let f = new Food(getRandomFoodType());
        f.x = Math.random() * (canvas.width - 100) + 50;
        f.y = Math.random() * (canvas.height - 100) + 50;
        const angle = Math.random() * Math.PI * 2;
        const speed = 1.5 + Math.random() * 2;
        f.vx = Math.cos(angle) * speed; f.vy = Math.sin(angle) * speed;
        foods.push(f);
    }
    requestAnimationFrame(gameLoop);
}

function gameOver() {
    gameState.isRunning = false; clearInterval(gameState.timerInterval);
    overlay.classList.remove('hidden');
    overlayContent.innerHTML = `
        <h1 class="text-4xl font-black mb-4 text-rose-500">æ™‚é–“åˆ°ï¼</h1>
        <p class="text-xl mb-2">ä½ çš„æœ€çµ‚åˆ†æ•¸</p>
        <div class="text-6xl font-black text-yellow-400 mb-6">${gameState.score}</div>
        <p class="mb-6 text-slate-300">æˆåŠŸé”æˆ <span class="text-emerald-400 font-bold">${gameState.level - 1}</span> æ¬¡å®Œç¾ 211 é¤ç›¤ï¼</p>
        <p class="mb-6 text-slate-400 text-sm">è·é›¢æ‹¯æ•‘æ³¢æ³¢ (20é—œ) é‚„å·®ä¸€é»é»å–”ï¼</p>
        <button onclick="location.reload()" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-black text-xl rounded-xl shadow-lg transform transition hover:scale-105">
            å†ç©ä¸€æ¬¡
        </button>
    `;
}

// --- æ‹¼åœ–é‚è¼¯ (æˆ‘çš„é¤ç›¤) ---
let selectedPuzzleFoodId = null;
let selectedPuzzleFoodElement = null;
let puzzleMatchedCount = 0;
const puzzleMsgBox = document.getElementById('puzzle-message');

function showPuzzleMessage(text, colorClass) {
    puzzleMsgBox.textContent = text;
    puzzleMsgBox.className = `h-16 mb-4 flex items-center justify-center text-center font-bold text-lg md:text-xl w-full rounded-xl whitespace-pre-line transition-all duration-300 ${colorClass} bg-slate-800/80 shadow-lg`;
}

function selectPuzzleFood(element, type) {
    if(selectedPuzzleFoodElement) selectedPuzzleFoodElement.classList.remove('selected');
    selectedPuzzleFoodElement = element;
    selectedPuzzleFoodId = type;
    element.classList.add('selected');
}

function placePuzzleFood(zoneElement, targetType) {
    if(!selectedPuzzleFoodElement) {
        showPuzzleMessage("âš ï¸ è«‹å…ˆé»é¸ä¸‹æ–¹çš„é£Ÿç‰©å–”ï¼", "text-amber-400");
        zoneElement.classList.add('shake');
        setTimeout(() => zoneElement.classList.remove('shake'), 400);
        return;
    }
    if(zoneElement.classList.contains('matched')) return; // å·²æ”¾å…¥

    if(selectedPuzzleFoodId === targetType) {
        // ç­”å°äº†ï¼
        zoneElement.innerHTML = selectedPuzzleFoodElement.innerHTML; // è¤‡è£½é£Ÿç‰©åœ–æ¡ˆéå»
        zoneElement.classList.add('matched');
        selectedPuzzleFoodElement.style.visibility = 'hidden'; // éš±è—ä¸‹æ–¹é¸é …
        selectedPuzzleFoodElement.classList.remove('selected');
        selectedPuzzleFoodElement = null;
        selectedPuzzleFoodId = null;
        puzzleMatchedCount++;
        showPuzzleMessage("âœ… å¤ªæ£’äº†ï¼æ”¾å°ä½ç½®äº†ï¼", "text-emerald-400");

        if(puzzleMatchedCount === 6) {
            setTimeout(showFinalVictory, 1000);
        }
    } else {
        // ç­”éŒ¯ï¼Œçµ¦äºˆå£è¨£æç¤º
        zoneElement.classList.add('shake');
        setTimeout(() => zoneElement.classList.remove('shake'), 400);

        let hint = "";
        if(targetType === 'veg') hint = "é£¯è·Ÿè”¬èœä¸€æ¨£å¤šã€èœæ¯”æ°´æœå¤šä¸€é»ï¼\né€™æ ¼æ˜¯æœ€å¤§çš„ï¼Œæ‡‰è©²æ”¾è”¬èœå–”ï¼";
        else if(targetType === 'carb') hint = "é£¯è·Ÿè”¬èœä¸€æ¨£å¤šï¼\né€™æ ¼æ‡‰è©²æ”¾å…¨ç©€é›œç³§å–”ï¼";
        else if(targetType === 'pro') hint = "è±†é­šè›‹è‚‰ä¸€æŒå¿ƒï¼\né€™æ ¼æ‡‰è©²æ”¾è›‹ç™½è³ªå–”ï¼";
        else if(targetType === 'fruit') hint = "æ¯é¤æ°´æœæ‹³é ­å¤§ï¼\né€™æ ¼æ‡‰è©²æ”¾æ°´æœå–”ï¼";
        else if(targetType === 'dairy') hint = "æ¯å¤©æ—©æ™šä¸€æ¯å¥¶ï¼\né€™æ ¼æ˜¯ä¹³å“å€å–”ï¼";
        else if(targetType === 'nut') hint = "æ¯é¤å …æœç¨®å­ä¸€èŒ¶åŒ™ï¼\né€™æ ¼æ˜¯å …æœå€å–”ï¼";

        showPuzzleMessage(`âŒ æ”¾éŒ¯å›‰ï¼\nğŸ’¡ æç¤ºï¼š${hint}`, "text-rose-400");
    }
}

function showFinalVictory() {
    document.getElementById('puzzle-overlay').classList.add('hidden');
    overlay.classList.remove('hidden');
    overlayContent.innerHTML = `
        <h1 class="text-4xl md:text-5xl font-black mb-4 text-emerald-400 neon-text">ä»»å‹™å¤§æˆåŠŸï¼</h1>
        <div class="text-8xl mb-6">ğŸ‘¾ğŸ‰</div>
        <p class="text-xl mb-4 leading-relaxed">ä½ æˆåŠŸçµ„æˆäº† 20 å€‹ 211 é¤ç›¤ï¼Œ<br>ä¸¦å®Œæˆäº†ã€Œæˆ‘çš„é¤ç›¤ã€å®Œç¾ç§˜æ–¹ï¼</p>
        <p class="mb-8 text-yellow-300 font-bold text-lg">æ³¢æ³¢å·²ç¶“æ¢å¾©æ»¿æ»¿çš„èƒ½é‡ï¼Œ<br>å¯ä»¥ç¹¼çºŒæ¢ç´¢å®‡å®™äº†ï¼</p>
        <div class="bg-slate-800 p-4 rounded-xl mb-6 text-sm text-slate-300 text-left border border-slate-600">
            <span class="text-white font-bold block mb-1">å¥åº·å£è¨£è¦è¨˜ç‰¢ï¼š</span>
            é£¯è·Ÿè”¬èœä¸€æ¨£å¤šã€èœæ¯”æ°´æœå¤šä¸€é»<br>
            è±†é­šè›‹è‚‰ä¸€æŒå¿ƒã€æ¯å¤©æ—©æ™šä¸€æ¯å¥¶<br>
            æ¯é¤æ°´æœæ‹³é ­å¤§ã€å …æœç¨®å­ä¸€èŒ¶åŒ™
        </div>
        <button onclick="location.reload()" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white font-black text-xl rounded-xl shadow-lg transform transition hover:scale-105">
            å†æ¬¡æŒ‘æˆ°
        </button>
    `;
}

</script>
</body>
</html>
